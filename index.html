<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Simulador Bancário — Quitação Antecipada Real</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
:root{
  --bg:#0f1115; --panel:#1a1c23; --muted:#a0a0a0; --gold:#f0b90b; --card:#1f212a; --accent:#f5f5f5; --glass:rgba(255,255,255,0.05);
}
:root.light{
  --bg:#f0f4f8; --panel:#ffffff; --muted:#555; --gold:#2b6cb0; --card:#ffffff; --accent:#0b1220; --glass:rgba(11,18,32,0.05);
}
*{box-sizing:border-box;font-family:Inter,system-ui,Arial;color:var(--accent);margin:0;padding:0;}
html,body{height:100%;width:100%;background:var(--bg);font-size:15px;-webkit-font-smoothing:antialiased;}

/* --- CONTAINER RESPONSIVO --- */
.container{
  max-width:1400px;
  margin:20px auto;
  padding:20px;
  display:grid;
  grid-template-columns:1fr 2fr;
  gap:20px;
  justify-content:center;
}

/* Cards, controles e KPIs */
.card{background:var(--card);padding:20px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.2);border:1px solid var(--glass);}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
.brand{font-weight:800;color:var(--gold);font-size:20px;letter-spacing:1px;}
.small{font-size:13px;color:var(--muted);}
.controls label{display:block;font-size:13px;color:var(--muted);margin-top:12px;font-weight:500;}
.controls input[type=text],.controls input[type=number],.controls select{
  background:var(--panel);color:var(--accent);border:1px solid var(--glass);padding:12px 10px;border-radius:10px;width:100%;margin-top:6px;transition:all 0.2s;
}
.controls input:focus,.controls select:focus{border-color:var(--gold);outline:none;box-shadow:0 0 8px var(--gold);}
.button{background:var(--gold);color:#0b0b0b;border:none;padding:12px 18px;border-radius:10px;cursor:pointer;font-weight:700;transition:all 0.2s;}
.button:hover{background:#e0a800;}
.button.ghost{background:transparent;border:1px solid var(--glass);color:var(--accent);}
.button.ghost:hover{background:var(--glass);}
.kpis{display:flex;gap:15px;flex-wrap:wrap;margin-top:12px;}
.kpi{background:var(--panel);padding:15px;border-radius:10px;min-width:160px;text-align:center;box-shadow:0 3px 10px rgba(0,0,0,0.15);}
.kpi .small{margin-bottom:8px;}

/* ===================== */
/* CORREÇÃO DO SCROLL    */
/* ===================== */

/* Contêiner externo da tabela */
.table-wrap {
  border-radius: 10px;
  border: 1px solid var(--glass);
  background: var(--panel);
  padding: 0;
}

/* Contêiner de rolagem (somente corpo rola) */
.table-scroll {
  max-height: 520px;
  overflow-y: auto;
  overflow-x: hidden;
  display: block;
  border-radius: 0 0 10px 10px;
  position: relative; /* contexto para sticky */
}

/* Tabelas */
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
  position: relative; /* garante contexto do sticky */
}

/* Cabeçalhos fixos */
thead th {
  position: sticky;
  top: 0;
  z-index: 2;
  background: inherit;
  padding: 8px;
  text-align: right;
}

tbody td {
  padding: 8px;
  text-align: right;
  border-bottom: 1px dashed rgba(255,255,255,0.05);
}

td:first-child,th:first-child{text-align:left;}
tbody tr:nth-child(even){background:rgba(255,255,255,0.03);}
.chart-area{height:400px;margin-top:12px;}

/* Comparativo lado a lado */
.comparison{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:20px;
  overflow-x:auto;
}

/* Theme toggle */
.theme-toggle{display:flex;gap:6px;align-items:center;}

/* Footer */
.footer{margin-top:12px;color:var(--muted);font-size:13px;}

/* --- MEDIA QUERIES --- */
@media(max-width:1100px){
  .container{
    grid-template-columns:1fr;
    padding:10px;
  }
  .comparison{
    grid-template-columns:1fr;
  }
}

/* ======================== */
/* MELHORIAS PREMIUM TABELAS */
/* ======================== */

/* --- TÍTULOS DAS TABELAS --- */
#titleA {
  background-color: #c9a84b;
  color: #0b0b0b;
  padding: 10px 15px;
  border-radius: 12px 12px 0 0;
  font-weight: 800;
  text-align: center;
  font-size: 16px;
  box-shadow: 0 3px 6px rgba(0,0,0,0.2);
  margin-bottom: 0;
}

#titleB {
  background-color: #2b6cb0;
  color: #ffffff;
  padding: 10px 15px;
  border-radius: 12px 12px 0 0;
  font-weight: 800;
  text-align: center;
  font-size: 16px;
  box-shadow: 0 3px 6px rgba(0,0,0,0.2);
  margin-bottom: 0;
}

/* --- BORDAS E FUNDO DAS TABELAS --- */
#tableA {
  border: 2px solid #c9a84b;
  border-radius: 0 0 12px 12px;
  background-color: rgba(201, 168, 75, 0.07);
  box-shadow: inset 0 0 8px rgba(201,168,75,0.15);
  transition: all 0.2s;
}

#tableB {
  border: 2px solid #2b6cb0;
  border-radius: 0 0 12px 12px;
  background-color: rgba(43, 108, 176, 0.07);
  box-shadow: inset 0 0 8px rgba(43,108,176,0.15);
  transition: all 0.2s;
}

/* --- CABEÇALHOS --- */
#tableA thead th {
  background-color: #f5f0d6;
  color: #0b0b0b;
  font-weight: 700;
  text-transform: uppercase;
  z-index: 3;
}

#tableB thead th {
  background-color: #cfe0f4;
  color: #0b1220;
  font-weight: 700;
  text-transform: uppercase;
  z-index: 3;
}

/* --- LINHAS --- */
#tableA tbody tr:nth-child(odd) {
  background-color: rgba(201, 168, 75, 0.08);
}

#tableB tbody tr:nth-child(odd) {
  background-color: rgba(43, 108, 176, 0.08);
}

#tableA tbody tr:hover, #tableB tbody tr:hover {
  background-color: rgba(255,255,255,0.1);
  transform: scale(1.01);
  transition: all 0.15s;
}

/* --- CÉLULAS --- */
#tableA tbody td, #tableB tbody td {
  padding: 10px 8px;
  text-align: right;
  transition: all 0.15s;
}

#tableA tbody td:first-child, #tableB tbody td:first-child {
  text-align: left;
  font-weight: 600;
}

/* --- RODAPÉ --- */
#tableA tbody tr:last-child td, #tableB tbody tr:last-child td {
  border-bottom: none;
}
  /* ====== TOTAIS COMPARATIVOS ====== */
.totals-comparison {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

.totals-card {
  padding: 15px 20px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.totals-card h4 {
  margin-bottom: 10px;
  font-weight: 700;
  text-transform: uppercase;
  font-size: 14px;
}

.totals-card.gold {
  border-left: 4px solid #c9a84b;
  background-color: rgba(201, 168, 75, 0.08);
}

.totals-card.blue {
  border-left: 4px solid #2b6cb0;
  background-color: rgba(43, 108, 176, 0.08);
}

.totals-grid {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.totals-grid div {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.totals-grid span {
  font-size: 13px;
  color: var(--muted);
}

.totals-grid strong {
  font-size: 15px;
  font-weight: 700;
  color: var(--accent);
}

/* Responsivo */
@media(max-width:900px){
  .totals-comparison {
    grid-template-columns: 1fr;
  }
}
</style>
</head>
<body>
<div class="container" id="appRoot">

  <!-- CONTROLES E KPIs -->
  <div>
    <div class="card header">
      <div>
        <div class="brand">APSPARCEIROS — Quitação Bancária Real</div>
        <div class="small">PRICE · SAC · SACRE · Quitação antecipada (PV) · 30/360</div>
      </div>
      <div style="text-align:right">
        <div class="small">Branding: APSPARCEIROS • <span id="nowDate"></span></div>
        <div class="theme-toggle" style="margin-top:8px">
          <label class="small">Tema</label>
          <select id="themeSelect" style="margin-left:8px">
            <option value="dark">Escuro / Dourado</option>
            <option value="light">Claro / Azul</option>
          </select>
        </div>
      </div>
    </div>

    <div class="card controls">
      <label>Valor do Financiamento (R$)</label>
      <input id="loanAmount" type="number" min="0" step="0.01" value="500000">
      <label>Entrada (R$)</label>
      <input id="downPayment" type="number" min="0" step="0.01" value="0">
      <label>Prazo (meses)</label>
      <input id="termMonths" type="number" min="1" step="1" value="240">
      <label>Taxa nominal</label>
      <div style="display:flex;gap:8px">
        <input id="rateValue" type="number" min="0" step="0.0001" value="11">
        <select id="ratePeriod" style="width:120px">
          <option value="a.a">% a.a.</option>
          <option value="a.m">% a.m.</option>
        </select>
      </div>
      <label>Conversão anual → mensal</label>
      <select id="autoConvert"><option value="1">Sim (geométrica)</option><option value="0">Não (divisão)</option></select>
      <label>Sistema A</label>
      <select id="systemA">
        <option value="price">PRICE</option>
        <option value="sac">SAC</option>
        <option value="sacre">SACRE</option>
        <option value="simples">Juros Simples</option>
        <option value="compostos">Juros Compostos (acum.)</option>
      </select>
      <label>Sistema B</label>
      <select id="systemB">
        <option value="sac">SAC</option>
        <option value="price">PRICE</option>
        <option value="sacre">SACRE</option>
        <option value="simples">Juros Simples</option>
        <option value="compostos">Juros Compostos (acum.)</option>
      </select>
      <label>Correção monetária (SACRE)</label>
      <select id="indexSelect"><option value="none">Nenhuma</option><option value="TR">TR (exemplo)</option><option value="IPCA">IPCA</option><option value="INCC">INCC</option></select>
      <label>Carência</label>
      <select id="carenciaType"><option value="none">Sem carência</option><option value="juros">Paga só juros</option><option value="total">Carência total (capitaliza)</option></select>
      <label>Meses de carência</label>
      <input id="carenciaMonths" type="number" min="0" step="1" value="0">
      <label>Base de contagem (dias)</label>
      <select id="dayCount"><option value="30/360">30/360</option><option value="actual/360">actual/360</option></select>

      <hr style="border:none;border-top:1px solid var(--glass);margin:12px 0">

      <label>Desconto nas últimas parcelas (%)</label>
      <input id="discountPercent" type="number" min="0" step="0.01" value="0">
      <label>Quantidade de parcelas com desconto</label>
      <input id="discountCount" type="number" min="0" step="1" value="0">

      <hr style="border:none;border-top:1px solid var(--glass);margin:12px 0">

      <label>Quitação antecipada</label>
      <div style="display:flex;gap:8px">
        <input id="settleMonth" type="number" min="0" step="1" value="0" placeholder="Mês da quitação (0 = nenhuma)">
        <input id="settleDiscountPct" type="number" min="0" step="0.01" value="0" placeholder="Desconto negociação %">
      </div>

      <label>Importar série de índices (CSV)</label>
      <input id="indexFile" type="file" accept="text/csv">
      <div class="small">CSV: mês (1,2,3...), fator (ex: 1.002). Usado por SACRE para aplicar correção.</div>

      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="btnCalc" class="button">Calcular (A & B)</button>
        <button id="btnReset" class="button ghost">Restaurar</button>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="btnExportXlsx" class="button ghost">Exportar Excel</button>
        <button id="btnExportPdf" class="button ghost">Gerar PDF</button>
      </div>
      <div class="footer">Observação: neste modo a quitação é real — a tabela é encerrada no mês de quitação e uma linha de quitação é inserida com o valor presente descontado.</div>
    </div>
  </div>

<!-- ============================ -->
<!-- COMPARATIVO E TABELAS -->
<!-- ============================ -->
<div>
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <strong>Comparativo / Tabelas</strong>
        <div class="small">Resultados lado a lado</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="btnTogglePrint" class="button ghost">Imprimir</button>
      </div>
    </div>

    <!-- ====== GRÁFICO ====== -->
    <div style="margin-top:12px" class="chart-area">
      <canvas id="compareChart" style="width:100%;height:100%"></canvas>
    </div>

    <!-- ====== TABELAS + TOTAIS + QUITAÇÃO ====== -->
<div style="margin-top:12px" class="table-wrap print-area" id="tableWrap">

  <!-- ====== COMPARATIVO ====== -->
  <div class="comparison" id="comparisonWrap">

    <!-- Tabela A -->
    <div>
      <h4 id="titleA">Sistema A</h4>
      <div class="table-scroll">
        <table id="tableA">
          <thead>
            <tr>
              <th>Mês</th>
              <th>Saldo Inicial</th>
              <th>Juros</th>
              <th>Amortização</th>
              <th>Prestação</th>
              <th>Desconto</th>
              <th>Saldo Final</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Tabela B -->
    <div>
      <h4 id="titleB">Sistema B</h4>
      <div class="table-scroll">
        <table id="tableB">
          <thead>
            <tr>
              <th>Mês</th>
              <th>Saldo Inicial</th>
              <th>Juros</th>
              <th>Amortização</th>
              <th>Prestação</th>
              <th>Desconto</th>
              <th>Saldo Final</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- ====== TOTAIS ====== -->
  <div class="totals-comparison" style="margin-top:20px">
    <!-- Totais do Sistema A -->
    <div class="totals-card gold">
      <h4>Totais — Sistema A</h4>
      <div class="totals-grid">
        <div><span>Prestação média (A)</span><strong id="avgInstallmentA">R$ 0,00</strong></div>
        <div><span>Juros totais (A)</span><strong id="totalInterestA">R$ 0,00</strong></div>
        <div><span>Saldo financiado (A)</span><strong id="financedA">R$ 0,00</strong></div>
      </div>
    </div>

    <!-- Totais do Sistema B -->
    <div class="totals-card blue">
      <h4>Totais — Sistema B</h4>
      <div class="totals-grid">
        <div><span>Prestação média (B)</span><strong id="avgInstallmentB">R$ 0,00</strong></div>
        <div><span>Juros totais (B)</span><strong id="totalInterestB">R$ 0,00</strong></div>
        <div><span>Saldo financiado (B)</span><strong id="financedB">R$ 0,00</strong></div>
      </div>
    </div>
  </div>

  <!-- ====== RODAPÉ DE QUITAÇÃO ====== -->
  <div style="margin-top:20px">
    <h4>Quitação antecipada / Simulação</h4>
    <div id="settleResult" class="small">Nenhuma quitação simulada.</div>
  </div>

</div>
<script>
// ==================== CONFIGURAÇÃO INICIAL ====================
document.getElementById('nowDate').innerText = new Date().toLocaleDateString();

// Tema
const themeSelect = document.getElementById('themeSelect');
themeSelect.addEventListener('change', ()=>document.documentElement.className = themeSelect.value);
document.documentElement.className = 'dark';

// Reset
document.getElementById('btnReset').addEventListener('click', ()=>location.reload());

// Formatação
function formatCurrency(v){return (v!==undefined?Number(v).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}):'-');}

// ==================== FUNÇÕES FINANCEIRAS ====================
function calcPRICE(P,i,n){return P*i/(1-Math.pow(1+i,-n));}
function calcSAC(P,n){return P/n;}
function calcSimple(saldo,rate){return saldo*rate;}
function calcCompound(saldo,rate){return saldo*rate;}

// ==================== SACRE REALISTA ====================
let indexData = []; // índices importados pelo CSV

function calcSACRE_Real(P, n, indices=[], carenciaType='none', carenciaMonths=0){
    let rows = [], saldo = P;
    for(let m=1; m<=n; m++){
        let ind = indices[m-1] ? indices[m-1] : 1; // fator de correção
        let amort = P/n;
        let juros = saldo*(ind-1); // correção monetária

        // Carência
        if(carenciaMonths>0 && m<=carenciaMonths){
            if(carenciaType==='juros'){ amort=0; }
            if(carenciaType==='total'){ juros=0; amort=0; saldo *= ind; }
        }

        let prest = amort + juros;
        let saldoIni = saldo;
        saldo -= amort;
        if(saldo<0) saldo=0;

        rows.push({month:m, saldoIni, juros, amort, prest, desconto:0, saldoFim:saldo});
        if(saldo===0) break;
    }
    return rows;
}

// ==================== BUILD TABLE ====================
function buildTable(P, rate, n, system, discount, settle, carenciaType, carenciaMonths){
    let rows=[], saldo=P, totalInterest=0, totalAmort=0, totalPay=0;
    let sacreRows = (system==='sacre') ? calcSACRE_Real(P,n,indexData,carenciaType,carenciaMonths) : [];

    for(let m=1; m<=n; m++){
        let juros=0, amort=0, prest=0, saldoIni=saldo;

        if(system==='price'){
            juros = saldo*rate;
            amort = calcPRICE(P,rate,n)-juros;
        } else if(system==='sac'){
            amort = P/n;
            juros = saldo*rate;
        } else if(system==='sacre'){
            if(m>sacreRows.length) break;
            let r = sacreRows[m-1];
            saldoIni = r.saldoIni; juros = r.juros; amort = r.amort; prest = r.prest;
        } else if(system==='simples'){
            juros = calcSimple(saldo, rate);
            amort = 0;
        } else if(system==='compostos'){
            juros = calcCompound(saldo, rate);
            amort = 0;
        }

        if(system!=='sacre'){ prest = juros + amort; }

        // Carência para outros sistemas
        if(carenciaMonths>0 && m<=carenciaMonths){
            if(carenciaType==='juros'){ amort=0; prest=juros; }
            if(carenciaType==='total'){ amort=0; prest=0; saldo *= (1+rate); }
        }

        // Desconto parcelas
        let desconto = 0;
        if(m>n-discount.count){ desconto = prest*(discount.percent/100); prest -= desconto; }

        // Quitação antecipada
        if(settle.month>0 && m===settle.month){
            prest *= (1-settle.pct/100);
            saldo=0;
        }

        saldo -= amort;
        if(saldo<0) saldo=0;

        totalInterest += juros;
        totalAmort += amort;
        totalPay += prest;

        rows.push({month:m, saldoIni, juros, amort, prest, desconto, saldoFim:saldo});
        if(saldo===0) break;
    }

    return {rows, totalInterest, totalAmort, totalPay};
}

// ==================== RENDER TABELAS ====================
function renderTables(){
    const P=Number(document.getElementById('loanAmount').value)-Number(document.getElementById('downPayment').value);
    const n=Number(document.getElementById('termMonths').value);
    let rate = Number(document.getElementById('rateValue').value)/100;
    const ratePeriod = document.getElementById('ratePeriod').value;
    if(ratePeriod==='a.a'){ rate /= 12; } // converte anual para mensal
    const systemA=document.getElementById('systemA').value;
    const systemB=document.getElementById('systemB').value;
    const discount={percent:Number(document.getElementById('discountPercent').value), count:Number(document.getElementById('discountCount').value)};
    const settle={month:Number(document.getElementById('settleMonth').value), pct:Number(document.getElementById('settleDiscountPct').value)};
    const carenciaType = document.getElementById('carenciaType').value;
    const carenciaMonths = Number(document.getElementById('carenciaMonths').value);

    const dataA = buildTable(P, rate, n, systemA, discount, settle, carenciaType, carenciaMonths);
    const dataB = buildTable(P, rate, n, systemB, discount, settle, carenciaType, carenciaMonths);

    // Render tabela
    ['A','B'].forEach(id=>{
        const tbody = document.querySelector(`#table${id} tbody`);
        tbody.innerHTML = '';
        const data = id==='A'?dataA:dataB;
        data.rows.forEach(r=>{
            let tr = document.createElement('tr');
            tr.innerHTML = `<td>${r.month}</td><td>${formatCurrency(r.saldoIni)}</td><td>${formatCurrency(r.juros)}</td><td>${formatCurrency(r.amort)}</td><td>${formatCurrency(r.prest)}</td><td>${formatCurrency(r.desconto)}</td><td>${formatCurrency(r.saldoFim)}</td>`;
            tbody.appendChild(tr);
        });
    });

    // Totais
    document.getElementById('totalPayA').innerText = formatCurrency(dataA.totalPay);
    document.getElementById('totalInterestA').innerText = formatCurrency(dataA.totalInterest);
    document.getElementById('totalAmortA').innerText = formatCurrency(dataA.totalAmort);
    document.getElementById('totalPayB').innerText = formatCurrency(dataB.totalPay);
    document.getElementById('totalInterestB').innerText = formatCurrency(dataB.totalInterest);
    document.getElementById('totalAmortB').innerText = formatCurrency(dataB.totalAmort);

    // Gráfico
    const ctx=document.getElementById('compareChart').getContext('2d');
    if(window.compareChart) window.compareChart.destroy();
    window.compareChart = new Chart(ctx,{
        type:'line',
        data:{
            labels: dataA.rows.map(r=>r.month),
            datasets:[
                {label:'Sistema A', data:dataA.rows.map(r=>r.saldoFim), borderColor:'#c9a84b', backgroundColor:'rgba(201,168,75,0.2)'},
                {label:'Sistema B', data:dataB.rows.map(r=>r.saldoFim), borderColor:'#2b6cb0', backgroundColor:'rgba(43,108,176,0.2)'}
            ]
        },
        options:{responsive:true, plugins:{legend:{position:'top'}}, scales:{y:{beginAtZero:true}}}
    });
}

// ==================== BOTÕES ====================
document.getElementById('btnCalc').addEventListener('click', renderTables);
document.getElementById('btnExportXlsx').addEventListener('click', ()=>{
    let wb=XLSX.utils.book_new();
    ['tableA','tableB'].forEach(id=>{
        let ws=XLSX.utils.table_to_sheet(document.getElementById(id));
        XLSX.utils.book_append_sheet(wb, ws, id);
    });
    XLSX.writeFile(wb,'simulacao.xlsx');
});
document.getElementById('btnExportPdf').addEventListener('click', ()=>{
    html2canvas(document.getElementById('tableWrap')).then(canvas=>{
        const img = canvas.toDataURL('image/png');
        const pdf = new jspdf.jsPDF('p','mm','a4');
        const w=210, h=canvas.height*(w/canvas.width);
        pdf.addImage(img,'PNG',0,0,w,h);
        pdf.save('simulacao.pdf');
    });
});

// ==================== IMPORTAÇÃO CSV ====================
document.getElementById('indexFile').addEventListener('change', e=>{
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(ev){
        const text = ev.target.result;
        indexData = text.split(/\r?\n/).map(line=>{
            let parts = line.split(',');
            return parseFloat(parts[1]) || 1;
        });
    };
    reader.readAsText(file);
});
</script>
</body>
</html>
