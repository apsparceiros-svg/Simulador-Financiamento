<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>APSPARCEIROS — Simulador Bancário v2.4</title>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
:root{
  --bg:#070707; --panel:#141414; --muted:#bdbdbd; --gold:#FFD700; --card:#0f0f0f; --accent:#e6e6e6; --glass:rgba(255,255,255,0.03);
  --blue:#00BFFF; --green:#00FF88; --danger:#f44336;
  --maxw:1600px;
}
:root.light{
  --bg:#f6f8fb; --panel:#ffffff; --muted:#444; --gold:#C19A00; --card:#ffffff; --accent:#0b1220; --glass:rgba(11,18,32,0.06);
  --blue:#0078FF; --green:#0b9b5b; --danger:#c62828;
}
*{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;color:var(--accent);margin:0;padding:0}
html,body{height:100%;width:100%;background:linear-gradient(180deg,var(--bg),#0b0b0b);-webkit-font-smoothing:antialiased;font-size:15px;overflow-y:auto;overflow-x:hidden}
.container{max-width:var(--maxw);margin:14px auto;padding:14px;display:flex;flex-direction:column;gap:14px}

/* Header */
.header{display:flex;flex-direction:column;align-items:center;gap:6px;padding:14px;border-radius:12px;background:linear-gradient(180deg,var(--panel),rgba(255,255,255,0.01));border:1px solid rgba(255,215,0,0.06)}
.brand h1{font-size:28px;color:var(--gold);text-shadow:0 0 14px rgba(255,215,0,0.12);margin:0;letter-spacing:2px}
.brand .sub{font-size:14px;color:var(--muted);margin-top:2px}

/* toolbar */
.toolbar{display:flex;justify-content:space-between;align-items:center;gap:10px;width:100%;margin-top:10px}
.controls{display:flex;gap:8px;align-items:center}
.btn{background:var(--gold);color:#0b0b0b;padding:10px 14px;border-radius:12px;border:none;font-weight:700;cursor:pointer;transition:0.2s}
.btn:hover{opacity:0.85}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--accent)}
.select, input{background:#1e1e1e;color:var(--accent);border:1px solid rgba(255,255,255,0.04);padding:10px;border-radius:10px;transition:0.2s}
.select.light, input.light{background:#fff;color:#111;border:1px solid #ddd}

/* Top row: parameters + KPIs */
.top-row{display:grid;grid-template-columns:1fr 500px;gap:14px;align-items:start}
.panel{background:var(--panel);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 6px 18px rgba(0,0,0,0.45);overflow:hidden}

/* parameters form */
.params{display:flex;flex-direction:column;gap:10px}
.section-title{font-weight:700;color:var(--gold);margin-bottom:10px;font-size:16px}
.small{font-size:13px;color:var(--muted)}
.input{width:100%;padding:10px;border-radius:10px;background:#1f1f1f;color:var(--accent);border:1px solid rgba(255,255,255,0.03)}

/* summary KPIs abaixo */
.kpis{display:flex;flex-direction:column;gap:8px;margin-top:16px}
.kpi-row{display:flex;gap:8px}
.kpi{flex:1;padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border:1px solid rgba(255,255,255,0.02)}
.kpi .label{font-size:12px;color:var(--muted)}
.kpi .value{font-weight:800;color:var(--gold);font-size:18px}

/* chart */
.chart-panel{height:380px;padding:14px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));border:1px solid rgba(255,255,255,0.03)}

/* tables compare */
.compare-wrap{display:flex;gap:12px;align-items:flex-start;justify-content:center}
.box{flex:1;min-width:0;overflow-x:auto}
.table{width:100%;border-collapse:collapse;font-size:14px}
.table thead th{position:sticky;top:0;padding:10px;text-align:right}
.table tbody td{padding:10px;text-align:right;border-bottom:1px dashed rgba(255,255,255,0.02)}
.table th:first-child, .table td:first-child{text-align:left;padding-left:12px}

/* table headers */
.tableA thead th{background:#262626;color:var(--gold);border-top:3px solid var(--gold)}
.tableA thead th.month{background:#333333;color:var(--blue);}
.tableB thead th{background:#102033;color:var(--blue);border-top:3px solid var(--blue)}
.tableB thead th.month{background:#333333;color:var(--blue)}

/* alternate rows */
.table tbody tr:nth-child(odd){background:rgba(255,255,255,0.008)}
.table tbody tr:nth-child(even){background:rgba(255,255,255,0.015)}

/* footer actions */
.actions{display:flex;gap:10px;justify-content:center;margin-top:10px}

/* responsive */
@media(max-width:1250px){
  .top-row{grid-template-columns:1fr}
  .toolbar{flex-direction:column;align-items:stretch}
  .chart-panel{height:260px}
  .compare-wrap{flex-direction:column}
}
</style>
</head>
<body>
<div class="container">

  <!-- Header -->
  <div class="header">
    <div class="brand">
      <h1>APSPARCEIROS</h1>
      <div class="sub">Simulador Bancário v2.4 — PRICE · SAC · SACRE · Quitação bancária real</div>
    </div>
    <div class="toolbar">
      <div class="controls">
        <div id="nowDate" class="small"></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <select id="themeSelect" class="select" title="Tema">
          <option value="dark">Escuro / Dourado</option>
          <option value="light">Claro / Azul</option>
        </select>
        <button id="btnExportXlsx" class="btn ghost">Exportar XLSX</button>
        <button id="btnExportCsv" class="btn ghost">Exportar CSV</button>
        <button id="btnExportPdf" class="btn ghost">Gerar PDF</button>
        <button id="btnPrint" class="btn ghost">Imprimir</button>
      </div>
    </div>
  </div>

  <!-- Top row: parameters + KPIs -->
  <div class="top-row">
    <div class="panel params" id="paramsPanel">
      <div class="section-title">Parâmetros</div>

      <label class="small">Valor do financiamento (R$)</label>
      <input id="loanAmount" class="input" type="number" value="500000">
      <label class="small">Entrada (R$)</label>
      <input id="downPayment" class="input" type="number" value="0">

      <div class="form-row" style="display:flex;gap:10px">
        <div class="col">
          <label class="small">Prazo (meses)</label>
          <input id="termMonths" class="input" type="number" value="240">
        </div>
        <div class="col">
          <label class="small">Taxa nominal</label>
          <div style="display:flex;gap:8px">
            <input id="rateValue" class="input" type="number" value="11" style="flex:1">
            <select id="ratePeriod" class="select"><option value="a.a">% a.a.</option><option value="a.m">% a.m.</option></select>
          </div>
        </div>
      </div>

      <label class="small">Conversão anual → mensal</label>
      <select id="autoConvert" class="select"><option value="1">Sim (geométrica)</option><option value="0">Não (divisão)</option></select>

      <div style="height:6px"></div>

      <div class="form-row" style="display:flex;gap:10px">
        <div class="col">
          <label class="small">Sistema A</label>
          <select id="systemA" class="select">
            <option value="price">PRICE</option>
            <option value="sac">SAC</option>
            <option value="sacre">SACRE</option>
            <option value="simples">Juros Simples</option>
            <option value="compostos">Juros Compostos</option>
          </select>
        </div>
        <div class="col">
          <label class="small">Sistema B</label>
          <select id="systemB" class="select">
            <option value="sac">SAC</option>
            <option value="price">PRICE</option>
            <option value="sacre">SACRE</option>
            <option value="simples">Juros Simples</option>
            <option value="compostos">Juros Compostos</option>
          </select>
        </div>
      </div>

      <div style="height:10px"></div>
      <button id="btnCalc" class="btn">Calcular A & B</button>
      <button id="btnReset" class="btn ghost">Restaurar</button>

      <!-- KPIs -->
      <div class="kpis" id="summaryPanel">
        <div class="kpi-row">
          <div class="kpi"><div class="label small">Prestação média (A)</div><div id="kpiPaymentA" class="value">-</div></div>
          <div class="kpi"><div class="label small">Juros totais (A)</div><div id="kpiTotalInterestA" class="value" style="color:var(--green)">-</div></div>
        </div>
        <div class="kpi-row">
          <div class="kpi"><div class="label small">Saldo financiado (A)</div><div id="kpiFinancedA" class="value">-</div></div>
          <div class="kpi"><div class="label small">Sistema A</div><div id="kpiSysA" class="value" style="color:var(--gold)">-</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart -->
  <div class="panel chart-panel">
    <canvas id="mainChart" style="width:100%;height:100%"></canvas>
  </div>

  <!-- Compare tables -->
  <div class="panel table-panel">
    <div class="compare-wrap">
      <div class="box">
        <h3 id="titleA" style="color:var(--gold)">A — PRICE</h3>
        <div style="max-height:420px;overflow:auto">
          <table id="tableA" class="table tableA">
            <thead><tr><th class="month">Mês</th><th>Saldo Inicial</th><th>Juros</th><th>Amortização</th><th>Prestação</th><th>Desconto</th><th>Saldo Final</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="box">
        <h3 id="titleB" style="color:var(--blue)">B — SAC</h3>
        <div style="max-height:420px;overflow:auto">
          <table id="tableB" class="table tableB">
            <thead><tr><th class="month">Mês</th><th>Saldo Inicial</th><th>Juros</th><th>Amortização</th><th>Prestação</th><th>Desconto</th><th>Saldo Final</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div style="margin-top:12px">
      <h4>Quitação antecipada</h4>
      <div id="settleResult" class="small">Nenhuma quitação simulada.</div>
    </div>

    <div class="actions">
      <button id="btnExportJson" class="btn ghost">Exportar JSON</button>
      <button id="btnExportCsv2" class="btn ghost">Exportar CSV (A/B)</button>
    </div>
  </div>
</div>

<script>
// -------------------------
// JAVASCRIPT COMPLETO DO SIMULADOR
// -------------------------

// Helper: formato moeda
function fMoney(n){return n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}

// Helper: gerar datas
function nowStr(){let d=new Date();return d.toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',year:'numeric'})}

// Converter taxa anual -> mensal
function convertRate(rate,period,auto){if(period==='a.a'){if(auto==='1') return Math.pow(1+rate/100,1/12)-1; else return rate/12/100;} else return rate/100}

// Gerar tabela PRICE
function genPRICE(P, r, n){
  let prest = P*r/(1-Math.pow(1+r,-n)), saldo=P, data=[]
  for(let i=1;i<=n;i++){
    let juros=saldo*r, amort=prest-juros, saldoFim=saldo-amort
    data.push({mes:i,saldoIni:saldo,juros,amort,prest,saldoFim})
    saldo=saldoFim
  }
  return data
}

// Gerar tabela SAC
function genSAC(P, r, n){
  let amort=P/n, saldo=P, data=[]
  for(let i=1;i<=n;i++){
    let juros=saldo*r, prest=amort+juros, saldoFim=saldo-amort
    data.push({mes:i,saldoIni:saldo,juros,amort,prest,saldoFim})
    saldo=saldoFim
  }
  return data
}

// Gerar tabela SACRE (SAC + reajuste anual)
function genSACRE(P, r, n){
  let amort=P/n, saldo=P, data=[], r0=r
  for(let i=1;i<=n;i++){
    if(i%12===1 && i>1) r*=1.02 // reajuste 2% ano (exemplo)
    let juros=saldo*r, prest=amort+juros, saldoFim=saldo-amort
    data.push({mes:i,saldoIni:saldo,juros,amort,prest,saldoFim})
    saldo=saldoFim
  }
  return data
}

// Preencher tabela HTML
function fillTable(id,arr){
  let tbody=document.querySelector(id+' tbody');tbody.innerHTML=''
  arr.forEach(r=>{
    let tr=document.createElement('tr')
    tr.innerHTML=`<td>${r.mes}</td>
      <td>${fMoney(r.saldoIni)}</td>
      <td>${fMoney(r.juros)}</td>
      <td>${fMoney(r.amort)}</td>
      <td>${fMoney(r.prest)}</td>
      <td>0</td>
      <td>${fMoney(r.saldoFim)}</td>`
    tbody.appendChild(tr)
  })
}

// Renderizar gráfico
let chart=null
function renderChart(dataA,dataB){
  let ctx=document.getElementById('mainChart').getContext('2d')
  if(chart) chart.destroy()
  chart=new Chart(ctx,{type:'line',
    data:{
      labels:dataA.map(d=>d.mes),
      datasets:[
        {label:'A',data:dataA.map(d=>d.saldoFim),borderColor:'#FFD700',backgroundColor:'rgba(255,215,0,0.1)'},
        {label:'B',data:dataB.map(d=>d.saldoFim),borderColor:'#00BFFF',backgroundColor:'rgba(0,191,255,0.1)'}
      ]
    },
    options:{responsive:true,plugins:{legend:{position:'top'}},scales:{y:{beginAtZero:false}}}
  })
}

// Atualizar KPIs
function updateKPIs(dataA,system){
  let sumPrest=dataA.reduce((a,b)=>a+b.prest,0)/dataA.length
  let sumJuros=dataA.reduce((a,b)=>a+b.juros,0)
  let saldoFin=dataA[0].saldoIni
  document.getElementById('kpiPaymentA').innerText=fMoney(sumPrest)
  document.getElementById('kpiTotalInterestA').innerText=fMoney(sumJuros)
  document.getElementById('kpiFinancedA').innerText=fMoney(saldoFin)
  document.getElementById('kpiSysA').innerText=system.toUpperCase()
}

// Calcular & renderizar
function calcAll(){
  let P=Number(document.getElementById('loanAmount').value)-Number(document.getElementById('downPayment').value)
  let n=Number(document.getElementById('termMonths').value)
  let rate=Number(document.getElementById('rateValue').value)
  let period=document.getElementById('ratePeriod').value
  let auto=document.getElementById('autoConvert').value
  let r=convertRate(rate,period,auto)
  let sysA=document.getElementById('systemA').value
  let sysB=document.getElementById('systemB').value

  let dataA=[],dataB=[]
  if(sysA==='price') dataA=genPRICE(P,r,n)
  if(sysA==='sac') dataA=genSAC(P,r,n)
  if(sysA==='sacre') dataA=genSACRE(P,r,n)
  if(sysB==='price') dataB=genPRICE(P,r,n)
  if(sysB==='sac') dataB=genSAC(P,r,n)
  if(sysB==='sacre') dataB=genSACRE(P,r,n)

  fillTable('#tableA',dataA)
  fillTable('#tableB',dataB)
  renderChart(dataA,dataB)
  updateKPIs(dataA,sysA)
}

// -------------------------
// Event listeners
// -------------------------
document.getElementById('btnCalc').addEventListener('click',calcAll)
document.getElementById('btnReset').addEventListener('click',()=>{location.reload()})
document.getElementById('nowDate').innerText='Data: '+nowStr()

// Theme switch
document.getElementById('themeSelect').addEventListener('change',e=>{
  if(e.target.value==='light') document.documentElement.classList.add('light')
  else document.documentElement.classList.remove('light')
})
</script>
</body>
</html>
