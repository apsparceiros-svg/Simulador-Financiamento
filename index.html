<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Simulador Bancário — Quitação Antecipada Real</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
/* =================== VARIÁVEIS DE TEMA =================== */
:root{
  --bg:#0f1115; --panel:#1a1c23; --muted:#a0a0a0; --gold:#f0b90b; --card:#1f212a; --accent:#f5f5f5; --glass:rgba(255,255,255,0.05);
}
:root.light{
  --bg:#f0f4f8; --panel:#ffffff; --muted:#555; --gold:#2b6cb0; --card:#ffffff; --accent:#0b1220; --glass:rgba(11,18,32,0.05);
}
/* =================== RESET E BASE =================== */
*{box-sizing:border-box;font-family:Inter,system-ui,Arial;color:var(--accent);margin:0;padding:0;}
html,body{height:100%;width:100%;background:var(--bg);font-size:15px;-webkit-font-smoothing:antialiased;}
/* =================== CONTAINER =================== */
.container{
  max-width:1400px;margin:20px auto;padding:20px;
  display:grid;grid-template-columns:1fr 2fr;gap:20px;justify-content:center;
}
/* =================== CARDS E CONTROLES =================== */
.card{background:var(--card);padding:20px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.2);border:1px solid var(--glass);}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
.brand{font-weight:800;color:var(--gold);font-size:20px;letter-spacing:1px;}
.small{font-size:13px;color:var(--muted);}
.controls label{display:block;font-size:13px;color:var(--muted);margin-top:12px;font-weight:500;}
.controls input[type=text],.controls input[type=number],.controls select{background:var(--panel);color:var(--accent);border:1px solid var(--glass);padding:12px 10px;border-radius:10px;width:100%;margin-top:6px;transition:all 0.2s;}
.controls input:focus,.controls select:focus{border-color:var(--gold);outline:none;box-shadow:0 0 8px var(--gold);}
.button{background:var(--gold);color:#0b0b0b;border:none;padding:12px 18px;border-radius:10px;cursor:pointer;font-weight:700;transition:all 0.2s;}
.button:hover{background:#e0a800;}
.button.ghost{background:transparent;border:1px solid var(--glass);color:var(--accent);}
.button.ghost:hover{background:var(--glass);}
.kpis{display:flex;gap:15px;flex-wrap:wrap;margin-top:12px;}
.kpi{background:var(--panel);padding:15px;border-radius:10px;min-width:160px;text-align:center;box-shadow:0 3px 10px rgba(0,0,0,0.15);}
.kpi .small{margin-bottom:8px;}
/* =================== TABELAS =================== */
.table-wrap {border-radius: 10px;border: 1px solid var(--glass);background: var(--panel);padding: 0;}
.table-scroll {max-height: 520px;overflow-y: auto;overflow-x: hidden;display: block;border-radius: 0 0 10px 10px;position: relative;}
table {width:100%;border-collapse: collapse;font-size:13px;position: relative;}
thead th {position: sticky;top: 0;z-index: 2;background: inherit;padding:8px;text-align:right;}
tbody td {padding:8px;text-align:right;border-bottom:1px dashed rgba(255,255,255,0.05);}
td:first-child,th:first-child{text-align:left;}
tbody tr:nth-child(even){background:rgba(255,255,255,0.03);}
.chart-area{height:400px;margin-top:12px;}
.comparison{display:grid;grid-template-columns:1fr 1fr;gap:20px;overflow-x:auto;}
.theme-toggle{display:flex;gap:6px;align-items:center;}
.footer{margin-top:12px;color:var(--muted);font-size:13px;}
@media(max-width:1100px){.container{grid-template-columns:1fr;padding:10px;}.comparison{grid-template-columns:1fr;}}

/* =================== TABELAS ESTILIZADAS =================== */
#titleA {background-color: #c9a84b;color: #0b0b0b;padding: 10px 15px;border-radius: 12px 12px 0 0;font-weight: 800;text-align: center;font-size: 16px;box-shadow: 0 3px 6px rgba(0,0,0,0.2);margin-bottom: 0;}
#titleB {background-color: #2b6cb0;color: #ffffff;padding: 10px 15px;border-radius: 12px 12px 0 0;font-weight: 800;text-align: center;font-size: 16px;box-shadow: 0 3px 6px rgba(0,0,0,0.2);margin-bottom: 0;}
#tableA {border:2px solid #c9a84b;border-radius:0 0 12px 12px;background-color: rgba(201, 168, 75, 0.07);box-shadow: inset 0 0 8px rgba(201,168,75,0.15);transition: all 0.2s;}
#tableB {border:2px solid #2b6cb0;border-radius:0 0 12px 12px;background-color: rgba(43,108,176,0.07);box-shadow: inset 0 0 8px rgba(43,108,176,0.15);transition: all 0.2s;}
#tableA thead th {background-color: #f5f0d6;color:#0b0b0b;font-weight:700;text-transform:uppercase;z-index:3;}
#tableB thead th {background-color: #cfe0f4;color:#0b1220;font-weight:700;text-transform:uppercase;z-index:3;}
#tableA tbody tr:nth-child(odd) {background-color: rgba(201, 168, 75, 0.08);}
#tableB tbody tr:nth-child(odd) {background-color: rgba(43, 108, 176, 0.08);}
#tableA tbody tr:hover, #tableB tbody tr:hover {background-color: rgba(255,255,255,0.1);transform: scale(1.01);transition: all 0.15s;}
#tableA tbody td, #tableB tbody td {padding: 10px 8px;text-align: right;transition: all 0.15s;}
#tableA tbody td:first-child, #tableB tbody td:first-child {text-align:left;font-weight:600;}
#tableA tbody tr:last-child td, #tableB tbody tr:last-child td {border-bottom:none;}
/* Totais comparativos */
.totals-comparison{display:grid;grid-template-columns:1fr 1fr;gap:20px;}
.totals-card{padding:15px 20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.2);}
.totals-card h4{margin-bottom:10px;font-weight:700;text-transform:uppercase;font-size:14px;}
.totals-card.gold{border-left:4px solid #c9a84b;background-color: rgba(201, 168, 75, 0.08);}
.totals-card.blue{border-left:4px solid #2b6cb0;background-color: rgba(43,108,176,0.08);}
.totals-grid{display:flex;flex-direction:column;gap:6px;}
.totals-grid div{display:flex;justify-content:space-between;align-items:center;}
.totals-grid span{font-size:13px;color:var(--muted);}
.totals-grid strong{font-size:15px;font-weight:700;color:var(--accent);}
@media(max-width:900px){.totals-comparison{grid-template-columns:1fr;}}
</style>
</head>
<body>
<div class="container" id="appRoot">
<!-- ================= CONTROLES E KPIs ================= -->
<div>
  <div class="card header">
    <div>
      <div class="brand">APSPARCEIROS — Quitação Bancária Real</div>
      <div class="small">PRICE · SAC · SACRE · Quitação antecipada (PV) · 30/360</div>
    </div>
    <div style="text-align:right">
      <div class="small">Branding: APSPARCEIROS • <span id="nowDate"></span></div>
      <div class="theme-toggle" style="margin-top:8px">
        <label class="small">Tema</label>
        <select id="themeSelect" style="margin-left:8px">
          <option value="dark">Escuro / Dourado</option>
          <option value="light">Claro / Azul</option>
        </select>
      </div>
    </div>
  </div>

  <div class="card controls">
    <!-- ================= INPUTS ================= -->
    <label>Valor do Financiamento (R$)</label>
    <input id="loanAmount" type="number" min="0" step="0.01" value="500000">
    <label>Entrada (R$)</label>
    <input id="downPayment" type="number" min="0" step="0.01" value="0">
    <label>Prazo (meses)</label>
    <input id="termMonths" type="number" min="1" step="1" value="240">
    <label>Taxa nominal</label>
    <div style="display:flex;gap:8px">
      <input id="rateValue" type="number" min="0" step="0.0001" value="11">
      <select id="ratePeriod" style="width:120px">
        <option value="a.a">% a.a.</option>
        <option value="a.m">% a.m.</option>
      </select>
    </div>
    <label>Conversão anual → mensal</label>
    <select id="autoConvert"><option value="1">Sim (geométrica)</option><option value="0">Não (divisão)</option></select>
    <label>Sistema A</label>
    <select id="systemA">
      <option value="price">PRICE</option>
      <option value="sac">SAC</option>
      <option value="sacre">SACRE</option>
      <option value="simples">Juros Simples</option>
      <option value="compostos">Juros Compostos (acum.)</option>
    </select>
    <label>Sistema B</label>
    <select id="systemB">
      <option value="sac">SAC</option>
      <option value="price">PRICE</option>
      <option value="sacre">SACRE</option>
      <option value="simples">Juros Simples</option>
      <option value="compostos">Juros Compostos (acum.)</option>
    </select>
    <label>Correção monetária (SACRE)</label>
    <select id="indexSelect"><option value="none">Nenhuma</option><option value="TR">TR (exemplo)</option><option value="IPCA">IPCA</option><option value="INCC">INCC</option></select>
    <label>Carência</label>
    <select id="carenciaType"><option value="none">Sem carência</option><option value="juros">Paga só juros</option><option value="total">Carência total (capitaliza)</option></select>
    <label>Meses de carência</label>
    <input id="carenciaMonths" type="number" min="0" step="1" value="0">
    <label>Base de contagem (dias)</label>
    <select id="dayCount"><option value="30/360">30/360</option><option value="actual/360">actual/360</option></select>

    <hr style="border:none;border-top:1px solid var(--glass);margin:12px 0">

    <label>Desconto nas últimas parcelas (%)</label>
    <input id="discountPercent" type="number" min="0" step="0.01" value="0">
    <label>Quantidade de parcelas com desconto</label>
    <input id="discountCount" type="number" min="0" step="1" value="0">

    <hr style="border:none;border-top:1px solid var(--glass);margin:12px 0">

    <label>Quitação antecipada</label>
    <div style="display:flex;gap:8px">
      <input id="settleMonth" type="number" min="0" step="1" value="0" placeholder="Mês da quitação (0 = nenhuma)">
      <input id="settleDiscountPct" type="number" min="0" step="0.01" value="0" placeholder="Desconto negociação %">
    </div>

    <label>Importar série de índices (CSV)</label>
    <input id="indexFile" type="file" accept="text/csv">
    <div class="small">CSV: mês (1,2,3...), fator (ex: 1.002). Usado por SACRE para aplicar correção.</div>

    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="btnCalc" class="button">Calcular (A & B)</button>
      <button id="btnReset" class="button ghost">Restaurar</button>
    </div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="btnExportXlsx" class="button ghost">Exportar Excel</button>
      <button id="btnExportPdf" class="button ghost">Gerar PDF</button>
    </div>
    <div class="footer">Observação: neste modo a quitação é real — a tabela é encerrada no mês de quitação e uma linha de quitação é inserida com o valor presente descontado.</div>
  </div>
</div>

<!-- ================= COMPARATIVO E TABELAS ================= -->
<div>
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <strong>Comparativo / Tabelas</strong>
        <div class="small">Resultados lado a lado</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="btnTogglePrint" class="button ghost">Imprimir</button>
      </div>
    </div>

    <div style="margin-top:12px" class="chart-area">
      <canvas id="compareChart" style="width:100%;height:100%"></canvas>
    </div>

    <div style="margin-top:12px" class="table-wrap print-area" id="tableWrap">
      <div class="comparison" id="comparisonWrap">
        <div>
          <h4 id="titleA">Sistema A</h4>
          <div class="table-scroll">
            <table id="tableA">
              <thead>
                <tr><th>Mês</th><th>Saldo Inicial</th><th>Juros</th><th>Amortização</th><th>Prestação</th><th>Desconto</th><th>Saldo Final</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div>
          <h4 id="titleB">Sistema B</h4>
          <div class="table-scroll">
            <table id="tableB">
              <thead>
                <tr><th>Mês</th><th>Saldo Inicial</th><th>Juros</th><th>Amortização</th><th>Prestação</th><th>Desconto</th><th>Saldo Final</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="totals-comparison" style="margin-top:20px">
        <div class="totals-card gold">
          <h4>Totais — Sistema A</h4>
          <div class="totals-grid">
            <div><span>Prestação média (A)</span><strong id="avgInstallmentA">R$0,00</strong></div>
            <div><span>Juros total</span><strong id="totalInterestA">R$0,00</strong></div>
            <div><span>Amortização total</span><strong id="totalAmortA">R$0,00</strong></div>
            <div><span>Saldo final</span><strong id="finalBalanceA">R$0,00</strong></div>
          </div>
        </div>
        <div class="totals-card blue">
          <h4>Totais — Sistema B</h4>
          <div class="totals-grid">
            <div><span>Prestação média (B)</span><strong id="avgInstallmentB">R$0,00</strong></div>
            <div><span>Juros total</span><strong id="totalInterestB">R$0,00</strong></div>
            <div><span>Amortização total</span><strong id="totalAmortB">R$0,00</strong></div>
            <div><span>Saldo final</span><strong id="finalBalanceB">R$0,00</strong></div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>
</div>

<script>
// ==================== UTILIDADES ====================
function formatBRL(v){return v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});}
function nowDate(){document.getElementById('nowDate').textContent=new Date().toLocaleDateString();}

// ==================== TEMA ====================
const themeSelect=document.getElementById('themeSelect');
themeSelect.addEventListener('change',e=>document.documentElement.className=e.target.value);

// ==================== EVENTOS ====================
document.getElementById('btnReset').addEventListener('click',()=>location.reload());
document.addEventListener('DOMContentLoaded',()=>{nowDate();});

// ==================== FUNÇÕES FINANCEIRAS ====================
function PMT(rate,nper,pv){return pv*rate/(1-Math.pow(1+rate,-nper));}
function calcSAC(pv,nper,rate){let arr=[];let amort=pv/nper;let saldo=pv;for(let i=1;i<=nper;i++){let j=saldo*rate;let prest=amort+j;arr.push({mes:i,saldo,saldoIni:saldo,juros:j,amort:amort,prest:prest,desconto:0});saldo-=amort;}return arr;}
function calcPRICE(pv,nper,rate){let pmt=PMT(rate,nper,pv);let saldo=pv;let arr=[];for(let i=1;i<=nper;i++){let j=saldo*rate;let amort=pmt-j;arr.push({mes:i,saldo,saldoIni:saldo,juros:j,amort:amort,prest:pmt,desconto:0});saldo-=amort;}return arr;}

// ==================== GERADOR DE TABELA ====================
function generateTable(system,amount,term,rate){
  let data=[];
  if(system==='sac') data=calcSAC(amount,term,rate);
  else if(system==='price') data=calcPRICE(amount,term,rate);
  // futuramente: SACRE, simples, compostos
  return data;
}

// ==================== RENDER TABLE ====================
function renderTable(tableId,data){
  let tbody=document.querySelector('#'+tableId+' tbody');tbody.innerHTML='';
  data.forEach(r=>{
    let tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.mes}</td>
      <td>${formatBRL(r.saldoIni)}</td>
      <td>${formatBRL(r.juros)}</td>
      <td>${formatBRL(r.amort)}</td>
      <td>${formatBRL(r.prest)}</td>
      <td>${formatBRL(r.desconto||0)}</td>
      <td>${formatBRL(r.saldo)}</td>`;
    tbody.appendChild(tr);
  });
}

// ==================== SIMULAÇÃO ====================
document.getElementById('btnCalc').addEventListener('click',()=>{
  let amount=parseFloat(document.getElementById('loanAmount').value);
  let term=parseInt(document.getElementById('termMonths').value);
  let rate=parseFloat(document.getElementById('rateValue').value)/100/12;
  let systemA=document.getElementById('systemA').value;
  let systemB=document.getElementById('systemB').value;

  let tableA=generateTable(systemA,amount,term,rate);
  let tableB=generateTable(systemB,amount,term,rate);

  renderTable('tableA',tableA);
  renderTable('tableB',tableB);

  // Atualiza totais
  document.getElementById('avgInstallmentA').textContent=formatBRL(tableA.reduce((a,b)=>a+b.prest,0)/tableA.length);
  document.getElementById('avgInstallmentB').textContent=formatBRL(tableB.reduce((a,b)=>a+b.prest,0)/tableB.length);
  document.getElementById('totalInterestA').textContent=formatBRL(tableA.reduce((a,b)=>a+b.juros,0));
  document.getElementById('totalInterestB').textContent=formatBRL(tableB.reduce((a,b)=>a+b.juros,0));
  document.getElementById('totalAmortA').textContent=formatBRL(tableA.reduce((a,b)=>a+b.amort,0));
  document.getElementById('totalAmortB').textContent=formatBRL(tableB.reduce((a,b)=>a+b.amort,0));
  document.getElementById('finalBalanceA').textContent=formatBRL(tableA[tableA.length-1].saldo);
  document.getElementById('finalBalanceB').textContent=formatBRL(tableB[tableB.length-1].saldo);
});
</script>
</body>
</html>
