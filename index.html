<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Simulador Banc√°rio ‚Äî Quita√ß√£o Antecipada Real</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
:root{
  --bg:#0f1115; --panel:#1a1c23; --muted:#a0a0a0; --gold:#f0b90b; --card:#1f212a; --accent:#f5f5f5; --glass:rgba(255,255,255,0.05);
}
:root.light{
  --bg:#f0f4f8; --panel:#ffffff; --muted:#555; --gold:#2b6cb0; --card:#ffffff; --accent:#0b1220; --glass:rgba(11,18,32,0.05);
}
*{box-sizing:border-box;font-family:Inter,system-ui,Arial;color:var(--accent);margin:0;padding:0;}
html,body{height:100%;width:100%;background:var(--bg);font-size:15px;-webkit-font-smoothing:antialiased;}

/* --- CONTAINER RESPONSIVO --- */
.container{
  max-width:1400px;
  margin:20px auto;
  padding:20px;
  display:grid;
  grid-template-columns:1fr 2fr;
  gap:20px;
  justify-content:center;
}

/* Cards, controles e KPIs */
.card{background:var(--card);padding:20px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.2);border:1px solid var(--glass);}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
.brand{font-weight:800;color:var(--gold);font-size:20px;letter-spacing:1px;}
.small{font-size:13px;color:var(--muted);}
.controls label{display:block;font-size:13px;color:var(--muted);margin-top:12px;font-weight:500;}
.controls input[type=text],.controls input[type=number],.controls select{
  background:var(--panel);color:var(--accent);border:1px solid var(--glass);padding:12px 10px;border-radius:10px;width:100%;margin-top:6px;transition:all 0.2s;
}
.controls input:focus,.controls select:focus{border-color:var(--gold);outline:none;box-shadow:0 0 8px var(--gold);}
.button{background:var(--gold);color:#0b0b0b;border:none;padding:12px 18px;border-radius:10px;cursor:pointer;font-weight:700;transition:all 0.2s;}
.button:hover{background:#e0a800;}
.button.ghost{background:transparent;border:1px solid var(--glass);color:var(--accent);}
.button.ghost:hover{background:var(--glass);}
.kpis{display:flex;gap:15px;flex-wrap:wrap;margin-top:12px;}
.kpi{background:var(--panel);padding:15px;border-radius:10px;min-width:160px;text-align:center;box-shadow:0 3px 10px rgba(0,0,0,0.15);}
.kpi .small{margin-bottom:8px;}

/* ===================== */
/* CORRE√á√ÉO DO SCROLL    */
/* ===================== */

/* Cont√™iner externo da tabela */
.table-wrap {
  border-radius: 10px;
  border: 1px solid var(--glass);
  background: var(--panel);
  padding: 0;
}

/* Cont√™iner de rolagem (somente corpo rola) */
.table-scroll {
  max-height: 520px;
  overflow-y: auto;
  overflow-x: hidden;
  display: block;
  border-radius: 0 0 10px 10px;
  position: relative; /* contexto para sticky */
}

/* Tabelas */
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
  position: relative; /* garante contexto do sticky */
}

/* Cabe√ßalhos fixos */
thead th {
  position: sticky;
  top: 0;
  z-index: 2;
  background: inherit;
  padding: 8px;
  text-align: right;
}

tbody td {
  padding: 8px;
  text-align: right;
  border-bottom: 1px dashed rgba(255,255,255,0.05);
}

td:first-child,th:first-child{text-align:left;}
tbody tr:nth-child(even){background:rgba(255,255,255,0.03);}
.chart-area{height:400px;margin-top:12px;}

/* Comparativo lado a lado */
.comparison{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:20px;
  overflow-x:auto;
}

/* Theme toggle */
.theme-toggle{display:flex;gap:6px;align-items:center;}

/* Footer */
.footer{margin-top:12px;color:var(--muted);font-size:13px;}

/* --- MEDIA QUERIES --- */
@media(max-width:1100px){
  .container{
    grid-template-columns:1fr;
    padding:10px;
  }
  .comparison{
    grid-template-columns:1fr;
  }
}

/* ======================== */
/* MELHORIAS PREMIUM TABELAS */
/* ======================== */

/* --- T√çTULOS DAS TABELAS --- */
#titleA {
  background-color: #c9a84b;
  color: #0b0b0b;
  padding: 10px 15px;
  border-radius: 12px 12px 0 0;
  font-weight: 800;
  text-align: center;
  font-size: 16px;
  box-shadow: 0 3px 6px rgba(0,0,0,0.2);
  margin-bottom: 0;
}

#titleB {
  background-color: #2b6cb0;
  color: #ffffff;
  padding: 10px 15px;
  border-radius: 12px 12px 0 0;
  font-weight: 800;
  text-align: center;
  font-size: 16px;
  box-shadow: 0 3px 6px rgba(0,0,0,0.2);
  margin-bottom: 0;
}

/* --- BORDAS E FUNDO DAS TABELAS --- */
#tableA {
  border: 2px solid #c9a84b;
  border-radius: 0 0 12px 12px;
  background-color: rgba(201, 168, 75, 0.07);
  box-shadow: inset 0 0 8px rgba(201,168,75,0.15);
  transition: all 0.2s;
}

#tableB {
  border: 2px solid #2b6cb0;
  border-radius: 0 0 12px 12px;
  background-color: rgba(43, 108, 176, 0.07);
  box-shadow: inset 0 0 8px rgba(43,108,176,0.15);
  transition: all 0.2s;
}

/* --- CABE√áALHOS --- */
#tableA thead th {
  background-color: #f5f0d6;
  color: #0b0b0b;
  font-weight: 700;
  text-transform: uppercase;
  z-index: 3;
}

#tableB thead th {
  background-color: #cfe0f4;
  color: #0b1220;
  font-weight: 700;
  text-transform: uppercase;
  z-index: 3;
}

/* --- LINHAS --- */
#tableA tbody tr:nth-child(odd) {
  background-color: rgba(201, 168, 75, 0.08);
}

#tableB tbody tr:nth-child(odd) {
  background-color: rgba(43, 108, 176, 0.08);
}

#tableA tbody tr:hover, #tableB tbody tr:hover {
  background-color: rgba(255,255,255,0.1);
  transform: scale(1.01);
  transition: all 0.15s;
}

/* --- C√âLULAS --- */
#tableA tbody td, #tableB tbody td {
  padding: 10px 8px;
  text-align: right;
  transition: all 0.15s;
}

#tableA tbody td:first-child, #tableB tbody td:first-child {
  text-align: left;
  font-weight: 600;
}

/* --- RODAP√â --- */
#tableA tbody tr:last-child td, #tableB tbody tr:last-child td {
  border-bottom: none;
}
  /* ====== TOTAIS COMPARATIVOS ====== */
.totals-comparison {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

.totals-card {
  padding: 15px 20px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.totals-card h4 {
  margin-bottom: 10px;
  font-weight: 700;
  text-transform: uppercase;
  font-size: 14px;
}

.totals-card.gold {
  border-left: 4px solid #c9a84b;
  background-color: rgba(201, 168, 75, 0.08);
}

.totals-card.blue {
  border-left: 4px solid #2b6cb0;
  background-color: rgba(43, 108, 176, 0.08);
}

.totals-grid {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.totals-grid div {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.totals-grid span {
  font-size: 13px;
  color: var(--muted);
}

.totals-grid strong {
  font-size: 15px;
  font-weight: 700;
  color: var(--accent);
}

/* Responsivo */
@media(max-width:900px){
  .totals-comparison {
    grid-template-columns: 1fr;
  }
}
</style>
</head>
<body>
<div class="container" id="appRoot">

  <!-- CONTROLES E KPIs -->
  <div>
    <div class="card header">
      <div>
        <div class="brand">APSPARCEIROS ‚Äî Quita√ß√£o Banc√°ria Real</div>
        <div class="small">PRICE ¬∑ SAC ¬∑ SACRE ¬∑ Quita√ß√£o antecipada (PV) ¬∑ 30/360</div>
      </div>
      <div style="text-align:right">
        <div class="small">Branding: APSPARCEIROS ‚Ä¢ <span id="nowDate"></span></div>
        <div class="theme-toggle" style="margin-top:8px">
          <label class="small">Tema</label>
          <select id="themeSelect" style="margin-left:8px">
            <option value="dark">Escuro / Dourado</option>
            <option value="light">Claro / Azul</option>
          </select>
        </div>
      </div>
    </div>

    <div class="card controls">
      <label>Valor do Financiamento (R$)</label>
      <input id="loanAmount" type="number" min="0" step="0.01" value="500000">
      <label>Entrada (R$)</label>
      <input id="downPayment" type="number" min="0" step="0.01" value="0">
      <label>Prazo (meses)</label>
      <input id="termMonths" type="number" min="1" step="1" value="240">
      <label>Taxa nominal</label>
      <div style="display:flex;gap:8px">
        <input id="rateValue" type="number" min="0" step="0.0001" value="11">
        <select id="ratePeriod" style="width:120px">
          <option value="a.a">% a.a.</option>
          <option value="a.m">% a.m.</option>
        </select>
      </div>
      <label>Convers√£o anual ‚Üí mensal</label>
      <select id="autoConvert"><option value="1">Sim (geom√©trica)</option><option value="0">N√£o (divis√£o)</option></select>
      <label>Sistema A</label>
      <select id="systemA">
        <option value="price">PRICE</option>
        <option value="sac">SAC</option>
        <option value="sacre">SACRE</option>
        <option value="simples">Juros Simples</option>
        <option value="compostos">Juros Compostos (acum.)</option>
      </select>
      <label>Sistema B</label>
      <select id="systemB">
        <option value="sac">SAC</option>
        <option value="price">PRICE</option>
        <option value="sacre">SACRE</option>
        <option value="simples">Juros Simples</option>
        <option value="compostos">Juros Compostos (acum.)</option>
      </select>
      <label>Corre√ß√£o monet√°ria (SACRE)</label>
      <select id="indexSelect"><option value="none">Nenhuma</option><option value="TR">TR (exemplo)</option><option value="IPCA">IPCA</option><option value="INCC">INCC</option></select>
      <label>Car√™ncia</label>
      <select id="carenciaType"><option value="none">Sem car√™ncia</option><option value="juros">Paga s√≥ juros</option><option value="total">Car√™ncia total (capitaliza)</option></select>
      <label>Meses de car√™ncia</label>
      <input id="carenciaMonths" type="number" min="0" step="1" value="0">
      <label>Base de contagem (dias)</label>
      <select id="dayCount"><option value="30/360">30/360</option><option value="actual/360">actual/360</option></select>

      <hr style="border:none;border-top:1px solid var(--glass);margin:12px 0">

      <label>Desconto nas √∫ltimas parcelas (%)</label>
      <input id="discountPercent" type="number" min="0" step="0.01" value="0">
      <label>Quantidade de parcelas com desconto</label>
      <input id="discountCount" type="number" min="0" step="1" value="0">

      <hr style="border:none;border-top:1px solid var(--glass);margin:12px 0">

      <label>Quita√ß√£o antecipada</label>
      <div style="display:flex;gap:8px">
        <input id="settleMonth" type="number" min="0" step="1" value="0" placeholder="M√™s da quita√ß√£o (0 = nenhuma)">
        <input id="settleDiscountPct" type="number" min="0" step="0.01" value="0" placeholder="Desconto negocia√ß√£o %">
      </div>

      <label>Importar s√©rie de √≠ndices (CSV)</label>
      <input id="indexFile" type="file" accept="text/csv">
      <div class="small">CSV: m√™s (1,2,3...), fator (ex: 1.002). Usado por SACRE para aplicar corre√ß√£o.</div>

      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="btnCalc" class="button">Calcular (A & B)</button>
        <button id="btnReset" class="button ghost">Restaurar</button>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="btnExportXlsx" class="button ghost">Exportar Excel</button>
        <button id="btnExportPdf" class="button ghost">Gerar PDF</button>
      </div>
      <div class="footer">Observa√ß√£o: neste modo a quita√ß√£o √© real ‚Äî a tabela √© encerrada no m√™s de quita√ß√£o e uma linha de quita√ß√£o √© inserida com o valor presente descontado.</div>
    </div>
  </div>

<!-- ============================ -->
<!-- COMPARATIVO E TABELAS -->
<!-- ============================ -->
<div>
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <strong>Comparativo / Tabelas</strong>
        <div class="small">Resultados lado a lado</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="btnTogglePrint" class="button ghost">Imprimir</button>
      </div>
    </div>

    <!-- ====== GR√ÅFICO ====== -->
    <div style="margin-top:12px" class="chart-area">
      <canvas id="compareChart" style="width:100%;height:100%"></canvas>
    </div>

    <!-- ====== TABELAS + TOTAIS + QUITA√á√ÉO ====== -->
<div style="margin-top:12px" class="table-wrap print-area" id="tableWrap">

  <!-- ====== COMPARATIVO ====== -->
  <div class="comparison" id="comparisonWrap">

    <!-- Tabela A -->
    <div>
      <h4 id="titleA">Sistema A</h4>
      <div class="table-scroll">
        <table id="tableA">
          <thead>
            <tr>
              <th>M√™s</th>
              <th>Saldo Inicial</th>
              <th>Juros</th>
              <th>Amortiza√ß√£o</th>
              <th>Presta√ß√£o</th>
              <th>Desconto</th>
              <th>Saldo Final</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Tabela B -->
    <div>
      <h4 id="titleB">Sistema B</h4>
      <div class="table-scroll">
        <table id="tableB">
          <thead>
            <tr>
              <th>M√™s</th>
              <th>Saldo Inicial</th>
              <th>Juros</th>
              <th>Amortiza√ß√£o</th>
              <th>Presta√ß√£o</th>
              <th>Desconto</th>
              <th>Saldo Final</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- ====== TOTAIS ====== -->
  <div class="totals-comparison" style="margin-top:20px">
    <!-- Totais do Sistema A -->
    <div class="totals-card gold">
      <h4>Totais ‚Äî Sistema A</h4>
      <div class="totals-grid">
        <div><span>Presta√ß√£o m√©dia (A)</span><strong id="avgInstallmentA">R$ 0,00</strong></div>
        <div><span>Juros totais (A)</span><strong id="totalInterestA">R$ 0,00</strong></div>
        <div><span>Saldo financiado (A)</span><strong id="financedA">R$ 0,00</strong></div>
      </div>
    </div>

    <!-- Totais do Sistema B -->
    <div class="totals-card blue">
      <h4>Totais ‚Äî Sistema B</h4>
      <div class="totals-grid">
        <div><span>Presta√ß√£o m√©dia (B)</span><strong id="avgInstallmentB">R$ 0,00</strong></div>
        <div><span>Juros totais (B)</span><strong id="totalInterestB">R$ 0,00</strong></div>
        <div><span>Saldo financiado (B)</span><strong id="financedB">R$ 0,00</strong></div>
      </div>
    </div>
  </div>

  <!-- ====== RODAP√â DE QUITA√á√ÉO ====== -->
  <div style="margin-top:20px">
    <h4>Quita√ß√£o antecipada / Simula√ß√£o</h4>
    <div id="settleResult" class="small">Nenhuma quita√ß√£o simulada.</div>
  </div>

</div>
<script>
/* Utilities & state */
document.getElementById('nowDate').innerText = new Date().toLocaleString('pt-BR',{year:'numeric',month:'short',day:'numeric'});
let indexSeries = {}; // month -> factor
let compareChart = null;
let lastA = null, lastB = null, lastMeta = null, lastSettle = null;

function fmt(v){ return Number(v).toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:2}); }
function roundBank(v){ return Math.round((Number(v)||0)*100)/100; }
function toMonthlyRate(value, period, auto){ const v = Number(value)/100; if(period==='a.m') return v; if(auto) return Math.pow(1+v,1/12)-1; return v/12; }

/* Parse CSV indices */
function parseIndexCSV(file, cb){
  const reader = new FileReader();
  reader.onload = e => {
    const txt = e.target.result;
    indexSeries = {};
    txt.split(/\r?\n/).forEach(line=>{
      const parts = line.split(/[,;|\t]/).map(s=>s.trim()).filter(Boolean);
      if(parts.length>=2){
        const m = Number(parts[0]);
        const f = Number(parts[1]);
        if(!isNaN(m) && !isNaN(f)) indexSeries[m] = f;
      }
    });
    cb && cb();
  };
  reader.readAsText(file);
}

/* Core: generate schedule with settlement applied (real quita√ß√£o) */
function generateBankSchedule(opts){
  // opts: amount, down, months, rate (monthly), system, carType, carMonths, dayCount, indexMap, reajPct, discountPct, discountCount, settleMonth, settleDiscountPct
  const amount = Number(opts.amount)||0;
  const down = Number(opts.down)||0;
  const totalMonths = Math.max(1,Math.floor(opts.months||1));
  const i = Number(opts.rate)||0; // monthly decimal
  const system = opts.system;
  const carType = opts.carType;
  const carMonths = Math.max(0,Math.floor(opts.carMonths||0));
  const indexMap = opts.indexMap || {};
  const reajPct = Number(opts.reaj)||0;
  const discountPct = Math.max(0, Number(opts.discountPct)||0);
  const discountCount = Math.max(0, Math.floor(opts.discountCount||0));
  const settleMonth = Number(opts.settleMonth)||0;
  const settleDiscountPct = Number(opts.settleDiscountPct)||0;

  let financed = Math.max(0, amount - down);
  let balance = financed;
  const schedule = [];

  function push(m, start, interest, amort, payment, discount, end, note){
    schedule.push({
      month: m,
      balanceStart: roundBank(start),
      interest: roundBank(interest),
      amortization: roundBank(amort),
      payment: roundBank(payment),
      discount: roundBank(discount||0),
      end: roundBank(end),
      note: note||''
    });
  }

  // Car√™ncia total: capitaliza
  if(carType==='total' && carMonths>0){
    for(let m=1;m<=carMonths;m++){
      const interest = balance * i;
      balance += interest;
      if(system==='sacre'){
        const factor = indexMap[m] || (1+reajPct/100);
        balance *= factor;
      }
      push(m, balance - interest, interest, 0, 0, 0, balance);
    }
  }

  // Car√™ncia juros: pay interest only
  if(carType==='juros' && carMonths>0){
    for(let m=1;m<=carMonths;m++){
      const interest = balance * i;
      push(m, balance, interest, 0, interest, 0, balance);
    }
  }

  const startMonth = (carType==='none')?1:(carMonths+1);
  const amortMonths = totalMonths - ((carType==='none')?0:carMonths);
  const M = Math.max(1, amortMonths);

  // Juros Compostos (acumulados) - pagamento √∫nico no final
  if(system==='compostos'){
    for(let m=1;m<=totalMonths;m++){
      const balStart = balance;
      const interest = balStart * i;
      balance = balStart + interest;
      const payment = (m===totalMonths) ? roundBank(balance) : 0;
      push(m, balStart, interest, 0, payment, 0, balance);
    }
  } else if(system==='price'){
    const ann = i;
    const payment = (ann===0) ? (balance / M) : balance * ann / (1 - Math.pow(1+ann, -M));
    for(let k=0;k<M;k++){
      const m = startMonth + k;
      const balStart = balance;
      const interest = balStart * i;
      const amort = payment - interest;
      balance = balStart - amort;
      push(m, balStart, interest, amort, payment, 0, balance);
    }
  } else if(system==='sac'){
    const amortConst = balance / M;
    for(let k=0;k<M;k++){
      const m = startMonth + k;
      const balStart = balance;
      const interest = balStart * i;
      const amort = amortConst;
      const payment = interest + amort;
      balance = balStart - amort;
      push(m, balStart, interest, amort, payment, 0, balance);
    }
  } else if(system==='sacre'){
    const amortConst = balance / M;
    for(let k=0;k<M;k++){
      const m = startMonth + k;
      const balStart = balance;
      const interest = balStart * i;
      const amort = amortConst;
      const payment = interest + amort;
      balance = balStart - amort;
      const factor = indexMap[m] || (1+reajPct/100);
      balance *= factor;
      push(m, balStart, interest, amort, payment, 0, balance);
    }
  } else if(system==='simples'){
    const amortConst = financed / M;
    for(let k=0;k<M;k++){
      const m = startMonth + k;
      const balStart = balance;
      const interest = financed * i;
      const amort = amortConst;
      const payment = interest + amort;
      balance = balStart - amort;
      push(m, balStart, interest, amort, payment, 0, balance);
    }
  }

 // ‚úÖ Aplica√ß√£o de desconto nas √∫ltimas N parcelas (como amortiza√ß√£o extra)
if (discountPct > 0 && discountCount > 0) {
  // Pega todas as parcelas que possuem pagamento
  const amortRows = schedule.filter(s => s.payment > 0);
  const L = amortRows.length;

  for (let j = 0; j < discountCount; j++) {
    const idx = L - 1 - j; // √∫ltimas parcelas
    if (idx < 0) break;

    const row = amortRows[idx];
    const globalIdx = schedule.findIndex(s => s.month === row.month);

    // Valor do desconto sobre a presta√ß√£o original
    const originalPayment = schedule[globalIdx].payment;
    const discountAmount = originalPayment * (discountPct / 100);

    // ‚úÖ L√≥gica corrigida: o desconto √© considerado amortiza√ß√£o adicional
    const newAmort = schedule[globalIdx].amortization + discountAmount;
    const newPayment = schedule[globalIdx].payment; // o cliente paga o mesmo valor
    const newEnd = schedule[globalIdx].balanceStart - newAmort;

    // Atualiza a linha da parcela
    schedule[globalIdx].discount = roundBank(discountAmount);
    schedule[globalIdx].amortization = roundBank(newAmort);
    schedule[globalIdx].payment = roundBank(newPayment);
    schedule[globalIdx].end = roundBank(newEnd);

    // üîÅ Propaga o novo saldo para as parcelas seguintes
    for (let t = globalIdx + 1; t < schedule.length; t++) {
      const prev = schedule[t - 1];
      schedule[t].balanceStart = roundBank(prev.end);
      schedule[t].interest = roundBank(schedule[t].balanceStart * i);

      if (schedule[t].payment > 0) {
        schedule[t].amortization = roundBank(schedule[t].payment - schedule[t].interest);
        schedule[t].end = roundBank(schedule[t].balanceStart - schedule[t].amortization);
      } else {
        schedule[t].end = schedule[t].balanceStart;
      }
    }
  }
}

  // QUITA√á√ÉO REAL: if settleMonth provided, compute PV of remaining flows and insert a settlement row
  if(settleMonth && settleMonth > 0){
    // PV of remaining payments after settleMonth
    let pv = 0;
    for(const r of schedule){
      if(r.month > settleMonth && r.payment > 0){
        const t = r.month - settleMonth;
        pv += r.payment / Math.pow(1 + i, t);
      }
    }
    const settlementRaw = pv * (1 - (settleDiscountPct || 0)/100);
    const settlement = roundBank(settlementRaw);

    // Keep schedule up to settleMonth (including it if exists); if settleMonth is during carencia months, we'll keep until that month.
    const upto = schedule.filter(s => s.month <= settleMonth);
    // Determine current balance start for settlement: if there is an entry for settleMonth use its end, else use last end available
    const lastRow = upto.length ? upto[upto.length-1] : null;
    const balanceBeforeSettlement = lastRow ? lastRow.end : (schedule.length ? schedule[schedule.length-1].end : roundBank(financed));

    // Insert settlement row as last real row with a small note; month uses .1 to sort after integer months if needed
    const settleRowMonth = settleMonth + 0.1;
    const settleRow = {
      month: settleRowMonth,
      balanceStart: roundBank(balanceBeforeSettlement),
      interest: 0,
      amortization: roundBank(settlement), // entire amount reduces balance to 0
      payment: roundBank(settlement),
      discount: roundBank((settleDiscountPct||0)),
      end: 0,
      note: 'Quita√ß√£o antecipada (PV descontado)'
    };

    // Build final schedule: upto + settlement row
    const finalSchedule = upto.slice();
    finalSchedule.push(settleRow);
    return { financed, schedule: finalSchedule, settlement: { pv: roundBank(pv), settlement } };
  }

  return { financed, schedule };
}

/* Settlement PV helper (standalone) */
function computeSettlement(schedule, currentMonth, monthlyRate, negotiationPct){
  const remaining = schedule.filter(r => r.month > currentMonth && r.payment > 0);
  let pv = 0;
  for(const r of remaining){
    const t = r.month - currentMonth;
    pv += r.payment / Math.pow(1 + monthlyRate, t);
  }
  const settlement = pv * (1 - negotiationPct/100);
  return { pv: roundBank(pv), settlement: roundBank(settlement), remainingCount: remaining.length };
}

/* Render & table */
function renderComparison(scheduleA, scheduleB, labelA, labelB){
  const maxM = Math.max(scheduleA.length ? Math.ceil(scheduleA[scheduleA.length-1].month) : 0, scheduleB.length ? Math.ceil(scheduleB[scheduleB.length-1].month) : 0);
  const labels = [];
  for(let i=1;i<=maxM;i++) labels.push('M'+i);

  const balA = labels.map((l,i)=>{ const m=i+1; const row = scheduleA.find(r=>Math.floor(r.month)===m); return row ? row.end : (scheduleA.length ? scheduleA[scheduleA.length-1].end : 0); });
  const balB = labels.map((l,i)=>{ const m=i+1; const row = scheduleB.find(r=>Math.floor(r.month)===m); return row ? row.end : (scheduleB.length ? scheduleB[scheduleB.length-1].end : 0); });

  const ctx = document.getElementById('compareChart').getContext('2d');
  if(compareChart){
    compareChart.data.labels = labels;
    compareChart.data.datasets[0].data = balA;
    compareChart.data.datasets[1].data = balB;
    compareChart.update();
    return;
  }

  compareChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: labelA, data: balA, borderColor: '#c9a84b', tension: 0.25 },
        { label: labelB, data: balB, borderColor: '#2b6cb0', tension: 0.25 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { labels: { color: 'var(--accent)' } } },
      scales: { x: { ticks: { color: 'var(--accent)' } }, y: { ticks: { color: 'var(--accent)' } } }
    }
  });
}

function fillTable(selector, schedule){
  const tbody = document.querySelector(selector + ' tbody');
  tbody.innerHTML = '';
  schedule.forEach(r=>{
    const tr = document.createElement('tr');
    const monthLabel = (Number.isInteger(r.month)) ? `M${r.month}` : `M${Math.floor(r.month)} (Quita√ß√£o)`;
    const note = r.note ? ` ‚Äî ${r.note}` : '';
    tr.innerHTML = `<td>${monthLabel}${note}</td>
      <td>${fmt(r.balanceStart)}</td>
      <td>${fmt(r.interest)}</td>
      <td>${fmt(r.amortization)}</td>
      <td>${fmt(r.payment)}</td>
      <td>${r.discount? (typeof r.discount==='number' && r.discount>0 ? (r.note? r.discount : fmt(r.discount)) : '-') : '-'}</td>
      <td>${fmt(r.end)}</td>`;
    tbody.appendChild(tr);
  });
}

/* Export functions */
function exportXlsx(objA, objB, meta){
  const wb = XLSX.utils.book_new();
  const sheetA = objA.schedule.map(r=>({
    Mes: r.month, SaldoInicial: r.balanceStart, Juros: r.interest, Amortizacao: r.amortization,
    Prestacao: r.payment, Desconto: r.discount||0, SaldoFinal: r.end, Nota: r.note||''
  }));
  const wsA = XLSX.utils.json_to_sheet(sheetA);
  XLSX.utils.book_append_sheet(wb, wsA, meta.titleA || 'TabelaA');

  const sheetB = objB.schedule.map(r=>({
    Mes: r.month, SaldoInicial: r.balanceStart, Juros: r.interest, Amortizacao: r.amortization,
    Prestacao: r.payment, Desconto: r.discount||0, SaldoFinal: r.end, Nota: r.note||''
  }));
  const wsB = XLSX.utils.json_to_sheet(sheetB);
  XLSX.utils.book_append_sheet(wb, wsB, meta.titleB || 'TabelaB');

  const metaArr = [
    ['APSPARCEIROS - Simula√ß√£o Banc√°ria (modo real)'],
    ['Data', meta.date],
    ['Valor', meta.amount],
    ['Entrada', meta.downpayment],
    ['Prazo (meses)', meta.months],
    ['Taxa mensal', (meta.rateMonthly*100).toFixed(6) + '%'],
    ['Sistema A', meta.titleA],
    ['Sistema B', meta.titleB]
  ];
  const wsMeta = XLSX.utils.aoa_to_sheet(metaArr);
  XLSX.utils.book_append_sheet(wb, wsMeta, 'Resumo');

  const wbout = XLSX.write(wb, { bookType:'xlsx', type:'array' });
  saveAs(new Blob([wbout], {type:'application/octet-stream'}), 'simulacao_bancaria_quitacao.xlsx');
}

async function exportPdf(element, meta, settleInfo){
  const { jsPDF } = window.jspdf;
  const canvas = await html2canvas(element, { scale: 1 });
  const img = canvas.toDataURL('image/png');
  const pdf = new jsPDF('landscape', 'pt', 'a4');
  const w = pdf.internal.pageSize.getWidth();
  const h = pdf.internal.pageSize.getHeight();
  pdf.setFontSize(12);
  pdf.text('APSPARCEIROS - Simula√ß√£o Banc√°ria (modo real)', 40, 30);
  pdf.text(meta.date, 40, 46);
  if(settleInfo) pdf.text('Quita√ß√£o: PV='+fmt(settleInfo.pv)+' | Valor com negocia√ß√£o='+fmt(settleInfo.settlement), 40, 62);
  pdf.addImage(img, 'PNG', 40, 80, w-80, h-140);
  pdf.save('simulacao_bancaria_quitacao.pdf');
}

/* Events */
document.getElementById('indexFile').addEventListener('change', (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  parseIndexCSV(f, ()=>{ alert('S√©rie de √≠ndices importada ('+Object.keys(indexSeries).length+' meses)'); });
});

document.getElementById('themeSelect').addEventListener('change', (e)=>{
  if(e.target.value === 'light') document.documentElement.classList.add('light');
  else document.documentElement.classList.remove('light');
});

document.getElementById('btnReset').addEventListener('click', ()=>{
  if(!confirm('Restaurar valores iniciais?')) return;
  location.reload();
});

document.getElementById('btnCalc').addEventListener('click', ()=>{
  const amount = Number(document.getElementById('loanAmount').value)||0;
  const down = Number(document.getElementById('downPayment').value)||0;
  const months = Number(document.getElementById('termMonths').value)||1;
  const rateVal = Number(document.getElementById('rateValue').value)||0;
  const ratePeriod = document.getElementById('ratePeriod').value;
  const auto = document.getElementById('autoConvert').value === '1';
  const sysA = document.getElementById('systemA').value;
  const sysB = document.getElementById('systemB').value;
  const indexType = document.getElementById('indexSelect').value;
  const carType = document.getElementById('carenciaType').value;
  const carMonths = Number(document.getElementById('carenciaMonths').value)||0;
  const dayCount = document.getElementById('dayCount').value;
  const discountPct = Number(document.getElementById('discountPercent').value)||0;
  const discountCount = Number(document.getElementById('discountCount').value)||0;
  const settleMonth = Number(document.getElementById('settleMonth').value)||0;
  const settleDiscountPct = Number(document.getElementById('settleDiscountPct').value)||0;

  const monthlyRate = toMonthlyRate(rateVal, ratePeriod, auto);
  const idxMap = indexSeries || {};

  // Pass settlement parameters into generator so it will produce a final schedule truncated at the settlement month
  const resA = generateBankSchedule({
    amount, down, months, rate: monthlyRate, system: sysA, carType, carMonths, dayCount,
    indexMap: idxMap, reaj: 0, discountPct, discountCount,
    settleMonth, settleDiscountPct
  });

  const resB = generateBankSchedule({
    amount, down, months, rate: monthlyRate, system: sysB, carType, carMonths, dayCount,
    indexMap: idxMap, reaj: 0, discountPct, discountCount,
    settleMonth, settleDiscountPct
  });

  fillTable('#tableA', resA.schedule);
  fillTable('#tableB', resB.schedule);
  document.getElementById('titleA').innerText = 'A ‚Äî ' + sysA.toUpperCase();
  document.getElementById('titleB').innerText = 'B ‚Äî ' + sysB.toUpperCase();

  renderComparison(resA.schedule, resB.schedule, 'A-'+sysA.toUpperCase(), 'B-'+sysB.toUpperCase());

  // KPIs A (totais acima)
const totInterestA = resA.schedule.reduce((s,x)=>s+Number(x.interest),0);
const avgPayA = resA.schedule.length ? (resA.schedule.reduce((s,x)=>s+Number(x.payment),0)/resA.schedule.length) : 0;
document.getElementById('avgInstallmentA').innerText = fmt(avgPayA);
document.getElementById('totalInterestA').innerText = fmt(totInterestA);
document.getElementById('financedA').innerText = fmt(resA.financed);

// KPIs B (totais acima)
const totInterestB = resB.schedule.reduce((s,x)=>s+Number(x.interest),0);
const avgPayB = resB.schedule.length ? (resB.schedule.reduce((s,x)=>s+Number(x.payment),0)/resB.schedule.length) : 0;
document.getElementById('avgInstallmentB').innerText = fmt(avgPayB);
document.getElementById('totalInterestB').innerText = fmt(totInterestB);
document.getElementById('financedB').innerText = fmt(resB.financed);

  // store
  lastA = resA; lastB = resB; lastMeta = { date: new Date().toLocaleString('pt-BR',{year:'numeric',month:'short',day:'numeric'}), amount, downpayment: down, months, rateMonthly: monthlyRate, titleA: sysA, titleB: sysB };

  // If generator returned settlement info (when settleMonth provided), show it
  if(resA.settlement){
    lastSettle = resA.settlement;
    document.getElementById('settleResult').innerText = `Quita√ß√£o no m√™s ${settleMonth}: PV dos fluxos = ${fmt(resA.settlement.pv)}; Valor com negocia√ß√£o: ${fmt(resA.settlement.settlement)} (parcelas remanescentes calculadas)`;
  } else {
    lastSettle = null;
    document.getElementById('settleResult').innerText = 'Nenhuma quita√ß√£o simulada.';
  }
});

document.getElementById('btnExportXlsx').addEventListener('click', ()=>{
  if(!lastA) return alert('Gere uma simula√ß√£o primeiro.');
  exportXlsx(lastA, lastB || {schedule:[]}, lastMeta);
});

document.getElementById('btnExportPdf').addEventListener('click', async ()=>{
  if(!lastA) return alert('Gere uma simula√ß√£o primeiro.');
  const elem = document.getElementById('tableWrap');
  await exportPdf(elem, lastMeta, lastSettle);
});

document.getElementById('btnTogglePrint').addEventListener('click', ()=> window.print());

/* Auto-run on load */
window.addEventListener('load', ()=>{
  document.documentElement.classList.remove('light'); // default: dark
  document.getElementById('themeSelect').value = 'dark';
  setTimeout(()=>document.getElementById('btnCalc').click(), 120);
});
</script>
</body>
</html>
